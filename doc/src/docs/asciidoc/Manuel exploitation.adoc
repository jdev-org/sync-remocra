= Manuel d'exploitation
Eau de Paris - Synchronisation Remocra
v${project.version}, ${timestamp}

:experimental:
:icons: font

:toc:

<<<

include::include/historique.adoc[]

<<<

:numbered:


* link:index.html[Accueil]


== Ubuntu 20.04

=== Images Docker temporaires

Les supprimer pour gagner de la place :
[source,sh]
----
# Lister
docker images --filter=dangling=true

# Nettoyer
docker image prune -f
----

Nettoyage préventif à quotidiennement à 1h :
[source,sh]
----
crontab -l
# Nettoyage préventif des images temporaires
0 1 * * *   docker image prune -f
----

=== Application

==== Vérifier les conteneurs et les images

[source,sh]
----
# Images
docker images | grep edp

# Conteneurs (uniquement les conteneurs en cours d'exécution si l'option "--rm" est systématiquement utilisée)
docker ps -a | grep edp
----

==== Exécuter l'application

Définition d'une fonction utilitaire pour la suite :
[source,sh]
----
# Exécution d'un conteneur avec : run-syncremocra --help
run-syncremocra() {
  # arguments
  export APP_ARGS="$@"
  export EDP_REGISTRY_PREFIX=$([ -z "${EDP_REGISTRY_SERVER}" ] || echo "${EDP_REGISTRY_SERVER}" | sed "s/\/\{0,1\}$/\//")
  export EDP_VERSION=$(cat /var/syncremocra/common.env | grep EDP_VERSION | cut -c13-)
  # run
  docker run --network="host" --rm \
    --env-file /var/syncremocra/common.env \
    --env LOG_FILENAME=syncremocra-db-validate.log \
    --user 2000:2000 \
    -v "/var/syncremocra/config":/app/config -v "/var/syncremocra/log":/app/log \
    ${EDP_REGISTRY_PREFIX}edp/syncremocra:${EDP_VERSION} \
    \
    $APP_ARGS
}
----

Exemple d'exécution :
[source,sh]
----
# Affichage de l'aide
run-syncremocra --help
----

==== Configurer l'application

**Journalisation**

Par défaut, la configuration de la journalisation est réalisée dans le fichier `/var/syncremocra/config/log4j2.xml`.

**Configuration commune aux contextes **

L'application est exécutée dans plusieurs contextes : `push`, `pull`, etc. Ceux-ci sont susceptibles d'évoluer en cours de projet : se référer à l'aide de l'application.

La configuration commune aux contextes est réalisée dans :

- le fichier `/var/syncremocra/common.env` pour les paramètres prévus. Exemple :
[source,sh]
----
# -- VERSION
EDP_VERSION=1.0-SNAPSHOT
# -- APP
#DATABASE_SERVERNAME=
#DATABASE_PORTNUMBER=
#DATABASE_DATABASENAME=
#DATABASE_USER=
DATABASE_PASSWORD=osLd48qd4f4
MAIL_USERNAME=
MAIL_PASSWORD=
MAIL_FROM=edp+admin@atolcd.com
MAIL_HOST=smtp-relay.hosting.priv.atolcd.com
MAIL_PORT=25
----
- le fichier `/var/syncremocra/config/syncremocra.conf` pour les autres.

**Configuration spécifique à un contexte**

Elle est réalisée avec le passage de variables d'environnement spécifiques au conteneur. Par exemple dans le fichier `/var/syncremocra/run<-contexte>.sh`.


==== Paramétrer les tâches planifiées

Sur l'utilisateur `edp` :
[source,sh]
----
crontab -u edp -l

# Exemple :
* * * * * /var/syncremocra/run-db-validate.sh
----


=== Gestion du schéma de la base de données ===

Utiliser la commande adéquate :
[source,sh]
----
# Validation (vérification)
run-syncremocra db-validate

# Migration (application des changements)
run-syncremocra db-migrate

# Réparation (reprend la table de version)
run-syncremocra db-repair
----



=== Services systèmes

Manipulation des services disponibles :
[source,sh]
----
# PostgreSQL
service postgresql status
service postgresql stop
service postgresql start
service postgresql reload
----



=== Journaux ===

* PostgreSQL : `/var/log/postgresql`
* Application : `/var/log/syncremocra`
